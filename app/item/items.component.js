"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var item_service_1 = require("../services/item.service");
var router_1 = require("@angular/router");
var router_2 = require("@angular/router");
// import { MapboxViewApi, Viewport as MapboxViewport } from "nativescript-mapbox";
var nativescript_angular_1 = require("nativescript-angular");
var observable_array_1 = require("data/observable-array");
var auth_service_1 = require("../services/auth.service");
var order_service_1 = require("../services/order.service");
var firebase = require("nativescript-plugin-firebase");
//trying location
var nativescript_geolocation_1 = require("nativescript-geolocation");
var color_1 = require("tns-core-modules/color");
// var Vibrate = require("nativescript-vibrate").Vibrate;
// let vibrator = new Vibrate();
var ItemsComponent = /** @class */ (function () {
    function ItemsComponent(itemService, router, route, routerextensions, auth, orderservice) {
        this.itemService = itemService;
        this.router = router;
        this.route = route;
        this.routerextensions = routerextensions;
        this.auth = auth;
        this.orderservice = orderservice;
        this.items = [];
        this.myItems = [];
        this.orderList = [];
        this._orderList = new observable_array_1.ObservableArray([]);
        this._items = new observable_array_1.ObservableArray([]);
        this.orderComplexLocal = [];
        this.orderComplexLocalFilter = [];
        this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
        this._order = new observable_array_1.ObservableArray([]);
        this.frequentCafes = [];
        this.startLocation = new nativescript_geolocation_1.Location();
        this.username = "";
        if (this.route.snapshot.params["tabId"] != null && this.route.snapshot.params["tabId"] == 1) {
            this.tabSelectedIndex = 1;
        }
        else {
            this.tabSelectedIndex = 0;
        }
    }
    ItemsComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.items != []) {
            this.itemService.load()
                .subscribe(function (items) {
                _this._items = new observable_array_1.ObservableArray(items);
                _this.items = [];
                _this._items.forEach(function (x) {
                    _this.items.push(x);
                });
                _this.myItems.length = 0;
                _this.filterByLocation();
            });
        }
        else {
            console.log("not loading again");
        }
        //order load for your picks
        firebase.getCurrentUser()
            .then(function (token) {
            console.log(token);
            _this.orderservice.loadOrder(token.uid)
                .subscribe(function (orderlist) {
                _this.orderComplexLocal = [];
                _this._orderList = new observable_array_1.ObservableArray(orderlist);
                _this.orderList = [];
                _this._orderList.forEach(function (x) {
                    _this.orderList.push(x);
                });
                _this.orderList.forEach(function (x) {
                    //get Cafe details
                    _this.orderservice.getOrderDetails(x.cafe, x.orderNo)
                        .then(function (result) {
                        _this.orderDisplay.cafeOwner = _this.itemService.getCafeInfo(x.cafe).name;
                        _this.orderDisplay.imgSrc = _this.itemService.getCafeInfo(x.cafe).imgSrc;
                        _this.orderDisplay.key = result.value.key;
                        _this.orderDisplay.uid = result.value.uid;
                        _this.orderDisplay.status = result.value.status;
                        _this.orderDisplay.orderNo2 = result.value.orderNo2;
                        _this.orderDisplay.order = result.value.order;
                        _this.orderDisplay.total = _this.totalPrice(_this.orderDisplay.order);
                        _this.orderComplexLocal.push(_this.orderDisplay);
                        _this.onTapCurrentOrder();
                        _this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
                            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
                    });
                });
            });
            _this.ontapListofFrequent(token.uid);
        });
    };
    //Frequently visited - to be completed ....
    ItemsComponent.prototype.ontapListofFrequent = function (token) {
        var _this = this;
        var counts;
        this.orderservice.frequentCafe(token)
            .then(function (res) {
            Object.keys(res.value).forEach(function (x) {
                _this.frequentCafes.push(res.value[x].cafe);
            });
        })
            .catch();
    };
    //Navitage to next screen
    ItemsComponent.prototype.jumptoMenu = function (cafeId, args) {
        var page = args.object;
        var view = page.getViewById("cafename");
        view.backgroundColor = new color_1.Color("#f0f0f0");
        view.animate({ backgroundColor: new color_1.Color("white"), duration: 200 });
        this.routerextensions.navigate(["/cafe", cafeId]);
    };
    //
    // //TabView controls
    ItemsComponent.prototype.changeTab = function () {
        if (this.tabSelectedIndex === 0) {
            this.tabSelectedIndex = 1;
        }
        else if (this.tabSelectedIndex === 1) {
            this.tabSelectedIndex = 2;
        }
        else if (this.tabSelectedIndex === 2) {
            this.tabSelectedIndex = 0;
        }
    };
    // search bar
    ItemsComponent.prototype.onTextChanged = function (args) {
        var searchBar = args.object;
        if (searchBar.text != "") {
            var searchValue_1 = searchBar.text.toLowerCase();
            if (searchBar.text != "") {
                this.myItems = this.items.filter(function (item) {
                    return (item.name + " " + item.name).toLowerCase().indexOf(searchValue_1.toLowerCase()) > -1;
                });
            }
            else {
                setTimeout(function () {
                    searchBar.dismissSoftInput();
                }, 300);
            }
        }
        else {
            // this.myItems.length=0;
            // this.filterByLocation();
        }
    };
    ItemsComponent.prototype.searchLoaded = function (event) {
        this.searchPhrase = "";
        event.object.android.setFocusableInTouchMode(false);
    };
    ItemsComponent.prototype.onSubmit = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onClear = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onRegister = function () {
        this.routerextensions.navigate(['register']);
    };
    ItemsComponent.prototype.onSignin = function () {
        this.routerextensions.navigate(['signin']);
    };
    ItemsComponent.prototype.onSignout = function () {
        this.auth.signout();
    };
    //For your picks...
    ItemsComponent.prototype.topThreeCafes = function () {
        this.orderservice.frequentCafe("CBNUluA6FogVIkOSlD4WKOFvMjf1");
    };
    ItemsComponent.prototype.onTapCurrentOrder = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status != "collected";
        });
    };
    ItemsComponent.prototype.onTapPastOrders = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status === "collected";
        });
    };
    ItemsComponent.prototype.totalPrice = function (order) {
        var total = "0";
        order.forEach(function (x) {
            //for total
            total = (Math.round((parseFloat(total) + parseFloat(x.price)) * 100) / 100).toString();
        });
        return total;
    };
    ItemsComponent.prototype.filterByLocation = function () {
        var _this = this;
        var date = new Date();
        this.items.forEach(function (x) {
            _this.myItems.length = 0;
            var that = _this;
            nativescript_geolocation_1.getCurrentLocation({ desiredAccuracy: 1, updateDistance: 10, maximumAge: 20000, timeout: 5000 }).
                then(function (loc) {
                if (loc) {
                    var a = nativescript_geolocation_1.distance(loc, { "latitude": x.lat, "longitude": x.lng, "direction": 0, "horizontalAccuracy": 14,
                        "verticalAccuracy": 14, "speed": 0, "altitude": 89, "timestamp": date });
                    if (a < 25000) {
                        that.myItems.push(x);
                    }
                    else {
                        //remove this when we need filtering by location
                        // that.myItems.push(x);
                    }
                }
            }, function (e) {
                //push anyway
                that.myItems.push(x);
            });
        });
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
            styleUrls: ["./items.component.css"]
        }),
        __metadata("design:paramtypes", [item_service_1.ItemService,
            router_2.Router,
            router_1.ActivatedRoute,
            nativescript_angular_1.RouterExtensions,
            auth_service_1.AuthService,
            order_service_1.OrderService])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWdEO0FBRWhELHlEQUF1RDtBQUN2RCwwQ0FBK0M7QUFDL0MsMENBQXdDO0FBQ3hDLG1GQUFtRjtBQUNuRiw2REFBc0Q7QUFDdEQsMERBQXNEO0FBS3RELHlEQUFxRDtBQUVyRCwyREFBdUQ7QUFFdkQsdURBQTBEO0FBRTFELGlCQUFpQjtBQUNqQixxRUFBOEk7QUFHOUksZ0RBQTZDO0FBRTdDLHlEQUF5RDtBQUN6RCxnQ0FBZ0M7QUFVaEM7SUFzQkksd0JBQW9CLFdBQXdCLEVBQ3hCLE1BQWEsRUFDYixLQUFvQixFQUNwQixnQkFBaUMsRUFDakMsSUFBZ0IsRUFDaEIsWUFBeUI7UUFMekIsZ0JBQVcsR0FBWCxXQUFXLENBQWE7UUFDeEIsV0FBTSxHQUFOLE1BQU0sQ0FBTztRQUNiLFVBQUssR0FBTCxLQUFLLENBQWU7UUFDcEIscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQUNqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBekI3QyxVQUFLLEdBQVMsRUFBRSxDQUFDO1FBQ2pCLFlBQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsY0FBUyxHQUFvRCxFQUFFLENBQUM7UUFDaEUsZUFBVSxHQUFxRSxJQUFJLGtDQUFlLENBQW1ELEVBQUUsQ0FBQyxDQUFDO1FBQ3pKLFdBQU0sR0FBeUIsSUFBSSxrQ0FBZSxDQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdELHNCQUFpQixHQUFnQixFQUFFLENBQUM7UUFDcEMsNEJBQXVCLEdBQWdCLEVBQUUsQ0FBQztRQUMxQyxpQkFBWSxHQUFjLEVBQUMsS0FBSyxFQUFDLEVBQUUsRUFBQyxLQUFLLEVBQUMsRUFBRSxFQUFDLFFBQVEsRUFBQyxFQUFFLEVBQUMsT0FBTyxFQUFFLElBQUk7WUFDbEUsV0FBVyxF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bkluaXR9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBJdGVtIH0gZnJvbSBcIi4uL2RhdGF0eXBlcy9pdGVtXCI7XG5pbXBvcnQgeyBJdGVtU2VydmljZSB9IGZyb20gXCIuLi9zZXJ2aWNlcy9pdGVtLnNlcnZpY2VcIjtcbmltcG9ydCB7QWN0aXZhdGVkUm91dGV9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcbmltcG9ydCB7IFJvdXRlcn0gZnJvbSBcIkBhbmd1bGFyL3JvdXRlclwiO1xuLy8gaW1wb3J0IHsgTWFwYm94Vmlld0FwaSwgVmlld3BvcnQgYXMgTWFwYm94Vmlld3BvcnQgfSBmcm9tIFwibmF0aXZlc2NyaXB0LW1hcGJveFwiO1xuaW1wb3J0IHtSb3V0ZXJFeHRlbnNpb25zfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFuZ3VsYXJcIjtcbmltcG9ydCB7T2JzZXJ2YWJsZUFycmF5fSBmcm9tIFwiZGF0YS9vYnNlcnZhYmxlLWFycmF5XCI7XG5pbXBvcnQgeyBTZWFyY2hCYXIgfSBmcm9tIFwidWkvc2VhcmNoLWJhclwiO1xuXG5cblxuaW1wb3J0IHtBdXRoU2VydmljZX0gZnJvbSBcIi4uL3NlcnZpY2VzL2F1dGguc2VydmljZVwiO1xuaW1wb3J0IHtPcmRlcn0gZnJvbSBcIi4uL2RhdGF0eXBlcy9vcmRlclwiO1xuaW1wb3J0IHtPcmRlclNlcnZpY2V9IGZyb20gXCIuLi9zZXJ2aWNlcy9vcmRlci5zZXJ2aWNlXCI7XG5pbXBvcnQge09yZGVyRGlzcGxheX0gZnJvbSBcIi4uL2RhdGF0eXBlcy9vcmRlci5kaXNwbGF5XCI7XG5pbXBvcnQgZmlyZWJhc2UgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXBsdWdpbi1maXJlYmFzZVwiKTtcblxuLy90cnlpbmcgbG9jYXRpb25cbmltcG9ydCB7TG9jYXRpb24sIGlzRW5hYmxlZCwgZW5hYmxlTG9jYXRpb25SZXF1ZXN0LCBnZXRDdXJyZW50TG9jYXRpb24sIHdhdGNoTG9jYXRpb24sIGRpc3RhbmNlLCBjbGVhcldhdGNoIH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1nZW9sb2NhdGlvblwiO1xuaW1wb3J0IHtBY2N1cmFjeX0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvdWkvZW51bXMvZW51bXNcIjtcbmltcG9ydCB7U3RhY2tMYXlvdXR9IGZyb20gXCJ1aS9sYXlvdXRzL3N0YWNrLWxheW91dFwiO1xuaW1wb3J0IHtDb2xvcn0gZnJvbSBcInRucy1jb3JlLW1vZHVsZXMvY29sb3JcIjtcbmltcG9ydCB7YW5kfSBmcm9tIFwiLi4vLi4vcGxhdGZvcm1zL2lvcy9EUUNhZmV2MDIvYXBwL3Ruc19tb2R1bGVzL0Bhbmd1bGFyL3JvdXRlci9zcmMvdXRpbHMvY29sbGVjdGlvblwiO1xuLy8gdmFyIFZpYnJhdGUgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXZpYnJhdGVcIikuVmlicmF0ZTtcbi8vIGxldCB2aWJyYXRvciA9IG5ldyBWaWJyYXRlKCk7XG5cblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwibnMtaXRlbXNcIixcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHRlbXBsYXRlVXJsOiBcIi4vaXRlbXMuY29tcG9uZW50Lmh0bWxcIixcbiAgICBzdHlsZVVybHM6W1wiLi9pdGVtcy5jb21wb25lbnQuY3NzXCJdXG59KVxuXG5leHBvcnQgY2xhc3MgSXRlbXNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXR7XG4gICAgYnVzaW5lc3NOYW1lOiBTdHJpbmdbXTtcbiAgICBpdGVtczogSXRlbVtdPVtdO1xuICAgIG15SXRlbXM6SXRlbVtdPVtdO1xuICAgIG9yZGVyTGlzdDp7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ31bXT1bXTtcbiAgICBfb3JkZXJMaXN0Ok9ic2VydmFibGVBcnJheTx7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ30+ID0gbmV3IE9ic2VydmFibGVBcnJheTx7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ30+KFtdKTtcbiAgICBfaXRlbXM6T2JzZXJ2YWJsZUFycmF5PEl0ZW0+ID0gbmV3IE9ic2VydmFibGVBcnJheTxJdGVtPihbXSk7XG4gICAgb3JkZXJDb21wbGV4TG9jYWw6T3JkZXJEaXNwbGF5W109W107XG4gICAgb3JkZXJDb21wbGV4TG9jYWxGaWx0ZXI6T3JkZXJEaXNwbGF5W109W107XG4gICAgb3JkZXJEaXNwbGF5Ok9yZGVyRGlzcGxheT17XCJrZXlcIjpcIlwiLFwidWlkXCI6XCJcIixcInN0YXR1c1wiOlwiXCIsXCJvcmRlclwiOiBudWxsLFxuICAgICAgICBcImNhZmVPd25lclwiOlwiXCIsXCJsb2NhdGlvblwiOlwiXCIsXCJvcmRlck5vMlwiOlwiXCIsXCJpbWdTcmNcIjpcIlwiLFwidG90YWxcIjpcIlwifVxuICAgIF9vcmRlcjpPYnNlcnZhYmxlQXJyYXk8T3JkZXJEaXNwbGF5PiA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8T3JkZXJEaXNwbGF5PihbXSk7XG4gICAgZnJlcXVlbnRDYWZlczpzdHJpbmdbXT1bXTtcblxuXG4gICAgc3RhcnRMb2NhdGlvbjpMb2NhdGlvbj1uZXcgTG9jYXRpb24oKTtcblxuICAgIHB1YmxpYyB0YWJTZWxlY3RlZEluZGV4OiBudW1iZXI7XG4gICAgcHVibGljIHNlYXJjaFBocmFzZTogc3RyaW5nO1xuICAgIHVzZXJuYW1lOnN0cmluZz1cIlwiO1xuICAgIHByaXZhdGUgX2N1cnJlbnROb3RpZmljYXRpb246IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaXRlbVNlcnZpY2U6IEl0ZW1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGVyOlJvdXRlcixcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlOkFjdGl2YXRlZFJvdXRlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGVyZXh0ZW5zaW9uczpSb3V0ZXJFeHRlbnNpb25zLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXV0aDpBdXRoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG9yZGVyc2VydmljZTpPcmRlclNlcnZpY2UpIHtcblxuICAgICAgICBpZih0aGlzLnJvdXRlLnNuYXBzaG90LnBhcmFtc1tcInRhYklkXCJdICE9IG51bGwgJiYgdGhpcy5yb3V0ZS5zbmFwc2hvdC5wYXJhbXNbXCJ0YWJJZFwiXSA9PSAxKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAxO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIG5nT25Jbml0KCk6IHZvaWQge1xuXG4gICAgICAgIGlmKHRoaXMuaXRlbXMhPVtdKXtcbiAgICAgICAgdGhpcy5pdGVtU2VydmljZS5sb2FkKClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKGl0ZW1zOiBBcnJheTxJdGVtPikgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMuX2l0ZW1zID0gbmV3IE9ic2VydmFibGVBcnJheShpdGVtcyk7XG4gICAgICAgICAgICAgICAgdGhpcy5pdGVtcz1bXTtcbiAgICAgICAgICAgICAgICB0aGlzLl9pdGVtcy5mb3JFYWNoKCh4KT0+e1xuICAgICAgICAgICAgICAgICAgICB0aGlzLml0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5teUl0ZW1zLmxlbmd0aD0wO1xuICAgICAgICAgICAgICAgIHRoaXMuZmlsdGVyQnlMb2NhdGlvbigpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZXtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKFwibm90IGxvYWRpbmcgYWdhaW5cIilcbiAgICAgICAgfVxuXG5cbi8vb3JkZXIgbG9hZCBmb3IgeW91ciBwaWNrc1xuICAgICAgICBmaXJlYmFzZS5nZXRDdXJyZW50VXNlcigpXG4gICAgICAgICAgICAudGhlbigodG9rZW4pPT4ge1xuICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHRva2VuKVxuICAgICAgICAgICAgICAgIHRoaXMub3JkZXJzZXJ2aWNlLmxvYWRPcmRlcih0b2tlbi51aWQpXG4gICAgICAgICAgICAgICAgICAgIC5zdWJzY3JpYmUoKG9yZGVybGlzdDogQXJyYXk8e1wib3JkZXJOb1wiOnN0cmluZyxcImNhZmVcIjpzdHJpbmcsXCJzdGF0dXNcIjpzdHJpbmd9PikgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbD1bXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29yZGVyTGlzdCA9IG5ldyBPYnNlcnZhYmxlQXJyYXkob3JkZXJsaXN0KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJMaXN0PVtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3JkZXJMaXN0LmZvckVhY2goKHgpPT57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckxpc3QucHVzaCh4KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyTGlzdC5mb3JFYWNoKCh4KT0+e1xuLy9nZXQgQ2FmZSBkZXRhaWxzXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJzZXJ2aWNlLmdldE9yZGVyRGV0YWlscyh4LmNhZmUseC5vcmRlck5vKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAudGhlbigocmVzdWx0KT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuY2FmZU93bmVyPXRoaXMuaXRlbVNlcnZpY2UuZ2V0Q2FmZUluZm8oeC5jYWZlKS5uYW1lO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuaW1nU3JjID0gdGhpcy5pdGVtU2VydmljZS5nZXRDYWZlSW5mbyh4LmNhZmUpLmltZ1NyYztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LmtleSA9IHJlc3VsdC52YWx1ZS5rZXk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS51aWQgPSByZXN1bHQudmFsdWUudWlkO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkuc3RhdHVzID0gcmVzdWx0LnZhbHVlLnN0YXR1cztcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5Lm9yZGVyTm8yID0gcmVzdWx0LnZhbHVlLm9yZGVyTm8yO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkub3JkZXI9cmVzdWx0LnZhbHVlLm9yZGVyO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkudG90YWw9dGhpcy50b3RhbFByaWNlKHRoaXMub3JkZXJEaXNwbGF5Lm9yZGVyKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbC5wdXNoKHRoaXMub3JkZXJEaXNwbGF5KTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25UYXBDdXJyZW50T3JkZXIoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5PSB7XCJrZXlcIjpcIlwiLFwidWlkXCI6XCJcIixcInN0YXR1c1wiOlwiXCIsXCJvcmRlclwiOiBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiY2FmZU93bmVyXCI6XCJcIixcImxvY2F0aW9uXCI6XCJcIixcIm9yZGVyTm8yXCI6XCJcIixcImltZ1NyY1wiOlwiXCIsXCJ0b3RhbFwiOlwiXCJ9O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLm9udGFwTGlzdG9mRnJlcXVlbnQodG9rZW4udWlkKTtcbiAgICAgICAgICAgIH0pO1xuXG4gICAgfVxuXG4vL0ZyZXF1ZW50bHkgdmlzaXRlZCAtIHRvIGJlIGNvbXBsZXRlZCAuLi4uXG5vbnRhcExpc3RvZkZyZXF1ZW50KHRva2VuKXtcbiAgICB2YXIgY291bnRzOiB7fVtdO1xuICAgICAgICB0aGlzLm9yZGVyc2VydmljZS5mcmVxdWVudENhZmUodG9rZW4pXG4gICAgICAgIC50aGVuKFxuICAgICAgICAgICAgKHJlcykgPT4ge1xuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKHJlcy52YWx1ZSkuZm9yRWFjaCgoeCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmZyZXF1ZW50Q2FmZXMucHVzaChyZXMudmFsdWVbeF0uY2FmZSk7XG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pXG4gICAgICAgIC5jYXRjaCgpO1xuICAgICAgICB9XG5cbi8vTmF2aXRhZ2UgdG8gbmV4dCBzY3JlZW5cbiAgICAgICAgICAgIGp1bXB0b01lbnUoY2FmZUlkLGFyZ3MpIHtcbiAgICAgICAgICAgICAgICBsZXQgcGFnZSA9IDxTdGFja0xheW91dD5hcmdzLm9iamVjdDtcbiAgICAgICAgICAgICAgICBsZXQgdmlldyA9IDxTdGFja0xheW91dD5wYWdlLmdldFZpZXdCeUlkKFwiY2FmZW5hbWVcIik7XG4gICAgICAgICAgICAgICAgdmlldy5iYWNrZ3JvdW5kQ29sb3IgPSBuZXcgQ29sb3IoXCIjZjBmMGYwXCIpO1xuICAgICAgICAgICAgICAgIHZpZXcuYW5pbWF0ZSh7IGJhY2tncm91bmRDb2xvcjogbmV3IENvbG9yKFwid2hpdGVcIiksIGR1cmF0aW9uOiAyMDAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICB0aGlzLnJvdXRlcmV4dGVuc2lvbnMubmF2aWdhdGUoW1wiL2NhZmVcIiwgY2FmZUlkXSk7XG4gICAgICAgICAgICB9XG4vL1xuLy8gLy9UYWJWaWV3IGNvbnRyb2xzXG4gICAgY2hhbmdlVGFiKCkge1xuXG4gICAgICAgIGlmICh0aGlzLnRhYlNlbGVjdGVkSW5kZXggPT09IDApIHtcbiAgICAgICAgICAgIHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9IDE7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50YWJTZWxlY3RlZEluZGV4ID09PSAxKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAyO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9PT0gMikge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMDtcbiAgICAgICAgfVxuXG5cbiAgICB9XG5cbi8vIHNlYXJjaCBiYXJcblxuICAgIHB1YmxpYyBvblRleHRDaGFuZ2VkKGFyZ3MpIHtcblxuICAgICAgICBsZXQgc2VhcmNoQmFyID0gPFNlYXJjaEJhcj5hcmdzLm9iamVjdDtcbiAgICAgICAgaWYgKHNlYXJjaEJhci50ZXh0IT1cIlwiKXtcbiAgICAgICAgbGV0IHNlYXJjaFZhbHVlID0gc2VhcmNoQmFyLnRleHQudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgaWYgKHNlYXJjaEJhci50ZXh0ICE9IFwiXCIpe1xuICAgICAgICAgICAgdGhpcy5teUl0ZW1zID0gdGhpcy5pdGVtcy5maWx0ZXIoIGl0ZW0gPT4ge1xuICAgICAgICAgICAgcmV0dXJuIGAke2l0ZW0ubmFtZX0gJHtpdGVtLm5hbWV9YC50b0xvd2VyQ2FzZSgpLmluZGV4T2Yoc2VhcmNoVmFsdWUudG9Mb3dlckNhc2UoKSkgPiAtMTtcbiAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCkge1xuICAgICAgICAgICAgICAgIHNlYXJjaEJhci5kaXNtaXNzU29mdElucHV0KCk7XG4gICAgICAgICAgICB9LCAzMDApO1xuICAgICAgICB9XG4gICAgfVxuICAgIGVsc2V7XG4gICAgICAgICAgICAvLyB0aGlzLm15SXRlbXMubGVuZ3RoPTA7XG4gICAgICAgICAgICAvLyB0aGlzLmZpbHRlckJ5TG9jYXRpb24oKTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHNlYXJjaExvYWRlZChldmVudCkge1xuICAgICAgICB0aGlzLnNlYXJjaFBocmFzZSA9IFwiXCI7XG4gICAgICAgIGV2ZW50Lm9iamVjdC5hbmRyb2lkLnNldEZvY3VzYWJsZUluVG91Y2hNb2RlKGZhbHNlKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgb25TdWJtaXQoYXJncykge1xuICAgICAgICBsZXQgc2VhcmNoYmFyID0gPFNlYXJjaEJhcj5hcmdzLm9iamVjdDtcbiAgICAgICAgc2VhcmNoYmFyLmRpc21pc3NTb2Z0SW5wdXQoKTtcbiAgICB9XG5cblxuICAgIHB1YmxpYyBvbkNsZWFyKGFyZ3MpIHtcbiAgICAgICAgbGV0IHNlYXJjaGJhciA9IDxTZWFyY2hCYXI+YXJncy5vYmplY3Q7XG4gICAgICAgIHNlYXJjaGJhci5kaXNtaXNzU29mdElucHV0KCk7XG4gICAgfVxuXG5cbiAgICBvblJlZ2lzdGVyKCl7XG5cbiAgICB0aGlzLnJvdXRlcmV4dGVuc2lvbnMubmF2aWdhdGUoWydyZWdpc3RlciddKTtcblxuICAgIH1cblxuICAgIG9uU2lnbmluKCl7XG5cbiAgICAgICAgdGhpcy5yb3V0ZXJleHRlbnNpb25zLm5hdmlnYXRlKFsnc2lnbmluJ10pO1xuXG4gICAgfVxuXG4gICAgb25TaWdub3V0KCl7XG5cbiAgICAgICAgdGhpcy5hdXRoLnNpZ25vdXQoKTtcbiAgICB9XG5cblxuLy9Gb3IgeW91ciBwaWNrcy4uLlxuICAgICAgICB0b3BUaHJlZUNhZmVzKCl7XG5cbiAgICAgICAgICAgIHRoaXMub3JkZXJzZXJ2aWNlLmZyZXF1ZW50Q2FmZShcIkNCTlVsdUE2Rm9nVklrT1NsRDRXS09Gdk1qZjFcIik7XG5cbiAgICAgICAgfVxuXG5cbiAgICBvblRhcEN1cnJlbnRPcmRlcigpe1xuICAgICAgICB0aGlzLm9yZGVyQ29tcGxleExvY2FsRmlsdGVyID0gdGhpcy5vcmRlckNvbXBsZXhMb2NhbC5maWx0ZXIoZnVuY3Rpb24gKHgpIHtcbiAgICAgICAgICAgIHJldHVybiB4LnN0YXR1cyAhPSBcImNvbGxlY3RlZFwiXG5cbiAgICAgICAgfSlcbiAgICB9XG5cblxuICAgIG9uVGFwUGFzdE9yZGVycygpe1xuICAgICAgICB0aGlzLm9yZGVyQ29tcGxleExvY2FsRmlsdGVyID0gdGhpcy5vcmRlckNvbXBsZXhMb2NhbC5maWx0ZXIoZnVuY3Rpb24oeCkge1xuICAgICAgICAgICAgcmV0dXJuIHguc3RhdHVzID09PSBcImNvbGxlY3RlZFwiXG4gICAgICAgIH0pXG4gICAgfVxuXG4gICAgdG90YWxQcmljZShvcmRlcjpPcmRlcltdKXtcbiAgICAgICAgdmFyIHRvdGFsPVwiMFwiO1xuICAgICAgICBvcmRlci5mb3JFYWNoKCh4KT0+e1xuICAgICAgICAgICAgLy9mb3IgdG90YWxcbiAgICAgICAgICAgIHRvdGFsPShNYXRoLnJvdW5kKChwYXJzZUZsb2F0KHRvdGFsKSsgcGFyc2VGbG9hdCh4LnByaWNlKSkqMTAwKS8xMDApLnRvU3RyaW5nKCk7XG4gICAgICAgIH0pO1xuICAgICAgICByZXR1cm4gdG90YWw7XG4gICAgfVxuXG4gICAgZmlsdGVyQnlMb2NhdGlvbigpe1xuICAgICAgICBjb25zdCBkYXRlOiBEYXRlID0gbmV3IERhdGUoKTtcbiAgICAgICAgdGhpcy5pdGVtcy5mb3JFYWNoKCh4KT0+e1xuXG4gICAgICAgIHRoaXMubXlJdGVtcy5sZW5ndGg9MDtcbiAgICAgICAgbGV0IHRoYXQgPSB0aGlzO1xuXG4gICAgICAgIGdldEN1cnJlbnRMb2NhdGlvbih7ZGVzaXJlZEFjY3VyYWN5OiAxLCB1cGRhdGVEaXN0YW5jZTogMTAsIG1heGltdW1BZ2U6IDIwMDAwLCB0aW1lb3V0OiA1MDAwfSkuXG4gICAgICAgIHRoZW4oZnVuY3Rpb24obG9jKSB7XG4gICAgICAgICAgICBpZiAobG9jKSB7XG4gICAgICAgICAgICAgICAgdmFyIGEgPSBkaXN0YW5jZShsb2Mse1wibGF0aXR1ZGVcIjp4LmxhdCxcImxvbmdpdHVkZVwiOngubG5nLCBcImRpcmVjdGlvblwiOjAsIFwiaG9yaXpvbnRhbEFjY3VyYWN5XCI6MTQsXG4gICAgICAgICAgICAgICAgICAgIFwidmVydGljYWxBY2N1cmFjeVwiOjE0LFwic3BlZWRcIjowLFwiYWx0aXR1ZGVcIjo4OSxcInRpbWVzdGFtcFwiOmRhdGV9KTtcbiAgICAgICAgICAgICAgICBpZihhPDI1MDAwKXtcbiAgICAgICAgICAgICAgICAgICAgdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIGVsc2V7XG4gICAgICAgICAgICAgICAgICAgIC8vcmVtb3ZlIHRoaXMgd2hlbiB3ZSBuZWVkIGZpbHRlcmluZyBieSBsb2NhdGlvblxuICAgICAgICAgICAgICAgICAgICAvLyB0aGF0Lm15SXRlbXMucHVzaCh4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH0sIGZ1bmN0aW9uKGUpe1xuICAgICAgICAgICAgLy9wdXNoIGFueXdheVxuICAgICAgICAgICAgdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIH0pXG4gICAgfVxuXG59XG4iXX0=