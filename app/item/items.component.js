"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var item_service_1 = require("../services/item.service");
var router_1 = require("@angular/router");
// import { MapboxViewApi, Viewport as MapboxViewport } from "nativescript-mapbox";
var nativescript_angular_1 = require("nativescript-angular");
var observable_array_1 = require("data/observable-array");
var auth_service_1 = require("../services/auth.service");
var order_service_1 = require("../services/order.service");
var firebase = require("nativescript-plugin-firebase");
//trying location
var nativescript_geolocation_1 = require("nativescript-geolocation");
var color_1 = require("tns-core-modules/color");
// var Vibrate = require("nativescript-vibrate").Vibrate;
// let vibrator = new Vibrate();
var ItemsComponent = /** @class */ (function () {
    function ItemsComponent(itemService, router, routerextensions, auth, orderservice) {
        this.itemService = itemService;
        this.router = router;
        this.routerextensions = routerextensions;
        this.auth = auth;
        this.orderservice = orderservice;
        this.items = [];
        this.myItems = [];
        this.orderList = [];
        this._orderList = new observable_array_1.ObservableArray([]);
        this._items = new observable_array_1.ObservableArray([]);
        this.orderComplexLocal = [];
        this.orderComplexLocalFilter = [];
        this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
        this._order = new observable_array_1.ObservableArray([]);
        this.frequentCafes = [];
        this.startLocation = new nativescript_geolocation_1.Location();
        this.username = "";
        this.tabSelectedIndex = 0;
    }
    ItemsComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.items != []) {
            this.itemService.load()
                .subscribe(function (items) {
                _this._items = new observable_array_1.ObservableArray(items);
                _this.items = [];
                _this._items.forEach(function (x) {
                    _this.items.push(x);
                });
                _this.myItems.length = 0;
                _this.filterByLocation();
            });
        }
        else {
            console.log("not loading again");
        }
        //order load for your picks
        firebase.getCurrentUser()
            .then(function (token) {
            console.log(token);
            _this.orderservice.loadOrder(token.uid)
                .subscribe(function (orderlist) {
                _this.orderComplexLocal = [];
                _this._orderList = new observable_array_1.ObservableArray(orderlist);
                _this.orderList = [];
                _this._orderList.forEach(function (x) {
                    _this.orderList.push(x);
                });
                _this.orderList.forEach(function (x) {
                    //get Cafe details
                    _this.orderservice.getOrderDetails(x.cafe, x.orderNo)
                        .then(function (result) {
                        _this.orderDisplay.cafeOwner = _this.itemService.getCafeInfo(x.cafe).name;
                        _this.orderDisplay.imgSrc = _this.itemService.getCafeInfo(x.cafe).imgSrc;
                        _this.orderDisplay.key = result.value.key;
                        _this.orderDisplay.uid = result.value.uid;
                        _this.orderDisplay.status = result.value.status;
                        _this.orderDisplay.orderNo2 = result.value.orderNo2;
                        _this.orderDisplay.order = result.value.order;
                        _this.orderDisplay.total = _this.totalPrice(_this.orderDisplay.order);
                        _this.orderComplexLocal.push(_this.orderDisplay);
                        _this.onTapCurrentOrder();
                        _this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
                            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
                    });
                });
            });
            _this.ontapListofFrequent(token.uid);
        });
    };
    //Frequently visited - to be completed ....
    ItemsComponent.prototype.ontapListofFrequent = function (token) {
        var _this = this;
        var counts;
        this.orderservice.frequentCafe(token)
            .then(function (res) {
            Object.keys(res.value).forEach(function (x) {
                _this.frequentCafes.push(res.value[x].cafe);
            });
        })
            .catch();
    };
    //Navitage to next screen
    ItemsComponent.prototype.jumptoMenu = function (cafeId, args) {
        var page = args.object;
        var view = page.getViewById("cafename");
        view.backgroundColor = new color_1.Color("#f0f0f0");
        view.animate({ backgroundColor: new color_1.Color("white"), duration: 200 });
        this.routerextensions.navigate(["/cafe", cafeId]);
    };
    //
    // //TabView controls
    ItemsComponent.prototype.changeTab = function () {
        if (this.tabSelectedIndex === 0) {
            this.tabSelectedIndex = 1;
        }
        else if (this.tabSelectedIndex === 1) {
            this.tabSelectedIndex = 2;
        }
        else if (this.tabSelectedIndex === 2) {
            this.tabSelectedIndex = 0;
        }
    };
    // search bar
    ItemsComponent.prototype.onTextChanged = function (args) {
        var searchBar = args.object;
        if (searchBar.text != "") {
            var searchValue_1 = searchBar.text.toLowerCase();
            if (searchBar.text != "") {
                this.myItems = this.items.filter(function (item) {
                    return (item.name + " " + item.name).toLowerCase().indexOf(searchValue_1.toLowerCase()) > -1;
                });
            }
            else {
                setTimeout(function () {
                    searchBar.dismissSoftInput();
                }, 300);
            }
        }
        else {
            // this.myItems.length=0;
            // this.filterByLocation();
        }
    };
    ItemsComponent.prototype.searchLoaded = function (event) {
        this.searchPhrase = "";
        event.object.android.setFocusableInTouchMode(false);
    };
    ItemsComponent.prototype.onSubmit = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onClear = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onRegister = function () {
        this.routerextensions.navigate(['register']);
    };
    ItemsComponent.prototype.onSignin = function () {
        this.routerextensions.navigate(['signin']);
    };
    ItemsComponent.prototype.onSignout = function () {
        this.auth.signout();
    };
    //For your picks...
    ItemsComponent.prototype.topThreeCafes = function () {
        this.orderservice.frequentCafe("CBNUluA6FogVIkOSlD4WKOFvMjf1");
    };
    ItemsComponent.prototype.onTapCurrentOrder = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status != "collected";
        });
    };
    ItemsComponent.prototype.onTapPastOrders = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status === "collected";
        });
    };
    ItemsComponent.prototype.totalPrice = function (order) {
        var total = "0";
        order.forEach(function (x) {
            //for total
            total = (Math.round((parseFloat(total) + parseFloat(x.price)) * 100) / 100).toString();
        });
        return total;
    };
    ItemsComponent.prototype.filterByLocation = function () {
        var _this = this;
        var date = new Date();
        this.items.forEach(function (x) {
            _this.myItems.length = 0;
            var that = _this;
            nativescript_geolocation_1.getCurrentLocation({ desiredAccuracy: 1, updateDistance: 10, maximumAge: 20000, timeout: 5000 }).
                then(function (loc) {
                if (loc) {
                    var a = nativescript_geolocation_1.distance(loc, { "latitude": x.lat, "longitude": x.lng, "direction": 0, "horizontalAccuracy": 14,
                        "verticalAccuracy": 14, "speed": 0, "altitude": 89, "timestamp": date });
                    if (a < 25000) {
                        that.myItems.push(x);
                    }
                    else {
                        //remove this when we need filtering by location
                        // that.myItems.push(x);
                    }
                }
            }, function (e) {
                //push anyway
                that.myItems.push(x);
            });
        });
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
            styleUrls: ["./items.component.css"]
        }),
        __metadata("design:paramtypes", [item_service_1.ItemService,
            router_1.Router,
            nativescript_angular_1.RouterExtensions,
            auth_service_1.AuthService,
            order_service_1.OrderService])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWdEO0FBRWhELHlEQUF1RDtBQUN2RCwwQ0FBd0M7QUFDeEMsbUZBQW1GO0FBQ25GLDZEQUFzRDtBQUN0RCwwREFBc0Q7QUFLdEQseURBQXFEO0FBRXJELDJEQUF1RDtBQUV2RCx1REFBMEQ7QUFFMUQsaUJBQWlCO0FBQ2pCLHFFQUE4STtBQUc5SSxnREFBNkM7QUFDN0MseURBQXlEO0FBQ3pELGdDQUFnQztBQVVoQztJQXNCSSx3QkFBb0IsV0FBd0IsRUFDeEIsTUFBYSxFQUNiLGdCQUFpQyxFQUNqQyxJQUFnQixFQUNoQixZQUF5QjtRQUp6QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixXQUFNLEdBQU4sTUFBTSxDQUFPO1FBQ2IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQUNqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBeEI3QyxVQUFLLEdBQVMsRUFBRSxDQUFDO1FBQ2pCLFlBQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsY0FBUyxHQUFvRCxFQUFFLENBQUM7UUFDaEUsZUFBVSxHQUFxRSxJQUFJLGtDQUFlLENBQW1ELEVBQUUsQ0FBQyxDQUFDO1FBQ3pKLFdBQU0sR0FBeUIsSUFBSSxrQ0FBZSxDQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdELHNCQUFpQixHQUFnQixFQUFFLENBQUM7UUFDcEMsNEJBQXVCLEdBQWdCLEVBQUUsQ0FBQztRQUMxQyxpQkFBWSxHQUFjLEVBQUMsS0FBSyxFQUFDLEVBQUUsRUFBQyxLQUFLLEVBQUMsRUFBRSxFQUFDLFFBQVEsRUFBQyxFQUFFLEVBQUMsT0FBTyxFQUFFLElBQUk7WUFDbEUsV0FBVyxFQUFDLEVBQUUsRUFBQyxVQUFVLEVBQUMsRUFBRSxFQUFDLFVBQVUsRUFBQyxFQUFFLEVB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QyxLQUFLLENBQUMsQ0FBQSxDQUFDO3dCQUNSLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN6QixDQUFDO29CQUNELElBQUksQ0FBQSxDQUFDO3dCQUNELGdEQUFnRDt3QkFDaEQsd0JBQXdCO29CQUM1QixDQUFDO2dCQUNMLENBQUM7WUFDTCxDQUFDLEVBQUUsVUFBUyxDQUFDO2dCQUNULGFBQWE7Z0JBQ2IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDekIsQ0FBQyxDQUFDLENBQUM7UUFFSCxDQUFDLENBQUMsQ0FBQTtJQUNOLENBQUM7SUEvT1EsY0FBYztRQVAxQixnQkFBUyxDQUFDO1lBQ1AsUUFBUSxFQUFFLFVBQVU7WUFDcEIsUUFBUSxFQUFFLE1BQU0sQ0FBQyxFQUFFO1lBQ25CLFdBQVcsRUFBRSx3QkFBd0I7WUFDckMsU0FBUyxFQUFDLENBQUMsdUJBQXVCLENBQUM7U0FDdEMsQ0FBQzt5Q0F3Qm1DLDBCQUFXO1lBQ2pCLGVBQU07WUFDSSx1Q0FBZ0I7WUFDNUIsMEJBQVc7WUFDSCw0QkFBWTtPQTFCcEMsY0FBYyxDQWlQMUI7SUFBRCxxQkFBQztDQUFBLEFBalBELElBaVBDO0FBalBZLHdDQUFjIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtDb21wb25lbnQsIE9uSW5pdH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCB7IEl0ZW0gfSBmcm9tIFwiLi4vZGF0YXR5cGVzL2l0ZW1cIjtcbmltcG9ydCB7IEl0ZW1TZXJ2aWNlIH0gZnJvbSBcIi4uL3NlcnZpY2VzL2l0ZW0uc2VydmljZVwiO1xuaW1wb3J0IHsgUm91dGVyfSBmcm9tIFwiQGFuZ3VsYXIvcm91dGVyXCI7XG4vLyBpbXBvcnQgeyBNYXBib3hWaWV3QXBpLCBWaWV3cG9ydCBhcyBNYXBib3hWaWV3cG9ydCB9IGZyb20gXCJuYXRpdmVzY3JpcHQtbWFwYm94XCI7XG5pbXBvcnQge1JvdXRlckV4dGVuc2lvbnN9IGZyb20gXCJuYXRpdmVzY3JpcHQtYW5ndWxhclwiO1xuaW1wb3J0IHtPYnNlcnZhYmxlQXJyYXl9IGZyb20gXCJkYXRhL29ic2VydmFibGUtYXJyYXlcIjtcbmltcG9ydCB7IFNlYXJjaEJhciB9IGZyb20gXCJ1aS9zZWFyY2gtYmFyXCI7XG5cblxuXG5pbXBvcnQge0F1dGhTZXJ2aWNlfSBmcm9tIFwiLi4vc2VydmljZXMvYXV0aC5zZXJ2aWNlXCI7XG5pbXBvcnQge09yZGVyfSBmcm9tIFwiLi4vZGF0YXR5cGVzL29yZGVyXCI7XG5pbXBvcnQge09yZGVyU2VydmljZX0gZnJvbSBcIi4uL3NlcnZpY2VzL29yZGVyLnNlcnZpY2VcIjtcbmltcG9ydCB7T3JkZXJEaXNwbGF5fSBmcm9tIFwiLi4vZGF0YXR5cGVzL29yZGVyLmRpc3BsYXlcIjtcbmltcG9ydCBmaXJlYmFzZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtcGx1Z2luLWZpcmViYXNlXCIpO1xuXG4vL3RyeWluZyBsb2NhdGlvblxuaW1wb3J0IHtMb2NhdGlvbiwgaXNFbmFibGVkLCBlbmFibGVMb2NhdGlvblJlcXVlc3QsIGdldEN1cnJlbnRMb2NhdGlvbiwgd2F0Y2hMb2NhdGlvbiwgZGlzdGFuY2UsIGNsZWFyV2F0Y2ggfSBmcm9tIFwibmF0aXZlc2NyaXB0LWdlb2xvY2F0aW9uXCI7XG5pbXBvcnQge0FjY3VyYWN5fSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy91aS9lbnVtcy9lbnVtc1wiO1xuaW1wb3J0IHtTdGFja0xheW91dH0gZnJvbSBcInVpL2xheW91dHMvc3RhY2stbGF5b3V0XCI7XG5pbXBvcnQge0NvbG9yfSBmcm9tIFwidG5zLWNvcmUtbW9kdWxlcy9jb2xvclwiO1xuLy8gdmFyIFZpYnJhdGUgPSByZXF1aXJlKFwibmF0aXZlc2NyaXB0LXZpYnJhdGVcIikuVmlicmF0ZTtcbi8vIGxldCB2aWJyYXRvciA9IG5ldyBWaWJyYXRlKCk7XG5cblxuQENvbXBvbmVudCh7XG4gICAgc2VsZWN0b3I6IFwibnMtaXRlbXNcIixcbiAgICBtb2R1bGVJZDogbW9kdWxlLmlkLFxuICAgIHRlbXBsYXRlVXJsOiBcIi4vaXRlbXMuY29tcG9uZW50Lmh0bWxcIixcbiAgICBzdHlsZVVybHM6W1wiLi9pdGVtcy5jb21wb25lbnQuY3NzXCJdXG59KVxuXG5leHBvcnQgY2xhc3MgSXRlbXNDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXR7XG4gICAgYnVzaW5lc3NOYW1lOiBTdHJpbmdbXTtcbiAgICBpdGVtczogSXRlbVtdPVtdO1xuICAgIG15SXRlbXM6SXRlbVtdPVtdO1xuICAgIG9yZGVyTGlzdDp7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ31bXT1bXTtcbiAgICBfb3JkZXJMaXN0Ok9ic2VydmFibGVBcnJheTx7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ30+ID0gbmV3IE9ic2VydmFibGVBcnJheTx7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ30+KFtdKTtcbiAgICBfaXRlbXM6T2JzZXJ2YWJsZUFycmF5PEl0ZW0+ID0gbmV3IE9ic2VydmFibGVBcnJheTxJdGVtPihbXSk7XG4gICAgb3JkZXJDb21wbGV4TG9jYWw6T3JkZXJEaXNwbGF5W109W107XG4gICAgb3JkZXJDb21wbGV4TG9jYWxGaWx0ZXI6T3JkZXJEaXNwbGF5W109W107XG4gICAgb3JkZXJEaXNwbGF5Ok9yZGVyRGlzcGxheT17XCJrZXlcIjpcIlwiLFwidWlkXCI6XCJcIixcInN0YXR1c1wiOlwiXCIsXCJvcmRlclwiOiBudWxsLFxuICAgICAgICBcImNhZmVPd25lclwiOlwiXCIsXCJsb2NhdGlvblwiOlwiXCIsXCJvcmRlck5vMlwiOlwiXCIsXCJpbWdTcmNcIjpcIlwiLFwidG90YWxcIjpcIlwifVxuICAgIF9vcmRlcjpPYnNlcnZhYmxlQXJyYXk8T3JkZXJEaXNwbGF5PiA9IG5ldyBPYnNlcnZhYmxlQXJyYXk8T3JkZXJEaXNwbGF5PihbXSk7XG4gICAgZnJlcXVlbnRDYWZlczpzdHJpbmdbXT1bXTtcblxuXG4gICAgc3RhcnRMb2NhdGlvbjpMb2NhdGlvbj1uZXcgTG9jYXRpb24oKTtcblxuICAgIHB1YmxpYyB0YWJTZWxlY3RlZEluZGV4OiBudW1iZXI7XG4gICAgcHVibGljIHNlYXJjaFBocmFzZTogc3RyaW5nO1xuICAgIHVzZXJuYW1lOnN0cmluZz1cIlwiO1xuICAgIHByaXZhdGUgX2N1cnJlbnROb3RpZmljYXRpb246IHN0cmluZztcblxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgaXRlbVNlcnZpY2U6IEl0ZW1TZXJ2aWNlLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGVyOlJvdXRlcixcbiAgICAgICAgICAgICAgICBwcml2YXRlIHJvdXRlcmV4dGVuc2lvbnM6Um91dGVyRXh0ZW5zaW9ucyxcbiAgICAgICAgICAgICAgICBwcml2YXRlIGF1dGg6QXV0aFNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSBvcmRlcnNlcnZpY2U6T3JkZXJTZXJ2aWNlKSB7XG4gICAgICAgIHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9IDA7XG4gICAgfVxuXG4gICAgbmdPbkluaXQoKTogdm9pZCB7XG5cbiAgICAgICAgaWYodGhpcy5pdGVtcyE9W10pe1xuICAgICAgICB0aGlzLml0ZW1TZXJ2aWNlLmxvYWQoKVxuICAgICAgICAgICAgLnN1YnNjcmliZSgoaXRlbXM6IEFycmF5PEl0ZW0+KSA9PiB7XG4gICAgICAgICAgICAgICAgdGhpcy5faXRlbXMgPSBuZXcgT2JzZXJ2YWJsZUFycmF5KGl0ZW1zKTtcbiAgICAgICAgICAgICAgICB0aGlzLml0ZW1zPVtdO1xuICAgICAgICAgICAgICAgIHRoaXMuX2l0ZW1zLmZvckVhY2goKHgpPT57XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuaXRlbXMucHVzaCh4KTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICB0aGlzLm15SXRlbXMubGVuZ3RoPTA7XG4gICAgICAgICAgICAgICAgdGhpcy5maWx0ZXJCeUxvY2F0aW9uKCk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNle1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJub3QgbG9hZGluZyBhZ2FpblwiKVxuICAgICAgICB9XG5cblxuLy9vcmRlciBsb2FkIGZvciB5b3VyIHBpY2tzXG4gICAgICAgIGZpcmViYXNlLmdldEN1cnJlbnRVc2VyKClcbiAgICAgICAgICAgIC50aGVuKCh0b2tlbik9PiB7XG4gICAgICAgICAgICAgICAgY29uc29sZS5sb2codG9rZW4pXG4gICAgICAgICAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UubG9hZE9yZGVyKHRva2VuLnVpZClcbiAgICAgICAgICAgICAgICAgICAgLnN1YnNjcmliZSgob3JkZXJsaXN0OiBBcnJheTx7XCJvcmRlck5vXCI6c3RyaW5nLFwiY2FmZVwiOnN0cmluZyxcInN0YXR1c1wiOnN0cmluZ30+KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyQ29tcGxleExvY2FsPVtdO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fb3JkZXJMaXN0ID0gbmV3IE9ic2VydmFibGVBcnJheShvcmRlcmxpc3QpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckxpc3Q9W107XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcmRlckxpc3QuZm9yRWFjaCgoeCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyTGlzdC5wdXNoKHgpO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG5cbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJMaXN0LmZvckVhY2goKHgpPT57XG4vL2dldCBDYWZlIGRldGFpbHNcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UuZ2V0T3JkZXJEZXRhaWxzKHguY2FmZSx4Lm9yZGVyTm8pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC50aGVuKChyZXN1bHQpPT57XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5jYWZlT3duZXI9dGhpcy5pdGVtU2VydmljZS5nZXRDYWZlSW5mbyh4LmNhZmUpLm5hbWU7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5pbWdTcmMgPSB0aGlzLml0ZW1TZXJ2aWNlLmdldENhZmVJbmZvKHguY2FmZSkuaW1nU3JjO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkua2V5ID0gcmVzdWx0LnZhbHVlLmtleTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LnVpZCA9IHJlc3VsdC52YWx1ZS51aWQ7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5zdGF0dXMgPSByZXN1bHQudmFsdWUuc3RhdHVzO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkub3JkZXJObzIgPSByZXN1bHQudmFsdWUub3JkZXJObzI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5vcmRlcj1yZXN1bHQudmFsdWUub3JkZXI7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS50b3RhbD10aGlzLnRvdGFsUHJpY2UodGhpcy5vcmRlckRpc3BsYXkub3JkZXIpXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyQ29tcGxleExvY2FsLnB1c2godGhpcy5vcmRlckRpc3BsYXkpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vblRhcEN1cnJlbnRPcmRlcigpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXk9IHtcImtleVwiOlwiXCIsXCJ1aWRcIjpcIlwiLFwic3RhdHVzXCI6XCJcIixcIm9yZGVyXCI6IG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJjYWZlT3duZXJcIjpcIlwiLFwibG9jYXRpb25cIjpcIlwiLFwib3JkZXJObzJcIjpcIlwiLFwiaW1nU3JjXCI6XCJcIixcInRvdGFsXCI6XCJcIn07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMub250YXBMaXN0b2ZGcmVxdWVudCh0b2tlbi51aWQpO1xuICAgICAgICAgICAgfSk7XG5cbiAgICB9XG5cbi8vRnJlcXVlbnRseSB2aXNpdGVkIC0gdG8gYmUgY29tcGxldGVkIC4uLi5cbm9udGFwTGlzdG9mRnJlcXVlbnQodG9rZW4pe1xuICAgIHZhciBjb3VudHM6IHt9W107XG4gICAgICAgIHRoaXMub3JkZXJzZXJ2aWNlLmZyZXF1ZW50Q2FmZSh0b2tlbilcbiAgICAgICAgLnRoZW4oXG4gICAgICAgICAgICAocmVzKSA9PiB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmtleXMocmVzLnZhbHVlKS5mb3JFYWNoKCh4KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuZnJlcXVlbnRDYWZlcy5wdXNoKHJlcy52YWx1ZVt4XS5jYWZlKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgfSlcbiAgICAgICAgLmNhdGNoKCk7XG4gICAgICAgIH1cblxuLy9OYXZpdGFnZSB0byBuZXh0IHNjcmVlblxuICAgICAgICAgICAganVtcHRvTWVudShjYWZlSWQsYXJncykge1xuICAgICAgICAgICAgICAgIGxldCBwYWdlID0gPFN0YWNrTGF5b3V0PmFyZ3Mub2JqZWN0O1xuICAgICAgICAgICAgICAgIGxldCB2aWV3ID0gPFN0YWNrTGF5b3V0PnBhZ2UuZ2V0Vmlld0J5SWQoXCJjYWZlbmFtZVwiKTtcbiAgICAgICAgICAgICAgICB2aWV3LmJhY2tncm91bmRDb2xvciA9IG5ldyBDb2xvcihcIiNmMGYwZjBcIik7XG4gICAgICAgICAgICAgICAgdmlldy5hbmltYXRlKHsgYmFja2dyb3VuZENvbG9yOiBuZXcgQ29sb3IoXCJ3aGl0ZVwiKSwgZHVyYXRpb246IDIwMCB9KTtcblxuICAgICAgICAgICAgICAgICAgIHRoaXMucm91dGVyZXh0ZW5zaW9ucy5uYXZpZ2F0ZShbXCIvY2FmZVwiLCBjYWZlSWRdKTtcbiAgICAgICAgICAgIH1cbi8vXG4vLyAvL1RhYlZpZXcgY29udHJvbHNcbiAgICBjaGFuZ2VUYWIoKSB7XG5cbiAgICAgICAgaWYgKHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9PT0gMCkge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMTtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhYlNlbGVjdGVkSW5kZXggPT09IDEpIHtcbiAgICAgICAgICAgIHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9IDI7XG4gICAgICAgIH0gZWxzZSBpZiAodGhpcy50YWJTZWxlY3RlZEluZGV4ID09PSAyKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAwO1xuICAgICAgICB9XG5cblxuICAgIH1cblxuLy8gc2VhcmNoIGJhclxuXG4gICAgcHVibGljIG9uVGV4dENoYW5nZWQoYXJncykge1xuXG4gICAgICAgIGxldCBzZWFyY2hCYXIgPSA8U2VhcmNoQmFyPmFyZ3Mub2JqZWN0O1xuICAgICAgICBpZiAoc2VhcmNoQmFyLnRleHQhPVwiXCIpe1xuICAgICAgICBsZXQgc2VhcmNoVmFsdWUgPSBzZWFyY2hCYXIudGV4dC50b0xvd2VyQ2FzZSgpO1xuICAgICAgICBpZiAoc2VhcmNoQmFyLnRleHQgIT0gXCJcIil7XG4gICAgICAgICAgICB0aGlzLm15SXRlbXMgPSB0aGlzLml0ZW1zLmZpbHRlciggaXRlbSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gYCR7aXRlbS5uYW1lfSAke2l0ZW0ubmFtZX1gLnRvTG93ZXJDYXNlKCkuaW5kZXhPZihzZWFyY2hWYWx1ZS50b0xvd2VyQ2FzZSgpKSA+IC0xO1xuICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgIHNldFRpbWVvdXQoZnVuY3Rpb24oKSB7XG4gICAgICAgICAgICAgICAgc2VhcmNoQmFyLmRpc21pc3NTb2Z0SW5wdXQoKTtcbiAgICAgICAgICAgIH0sIDMwMCk7XG4gICAgICAgIH1cbiAgICB9XG4gICAgZWxzZXtcbiAgICAgICAgICAgIC8vIHRoaXMubXlJdGVtcy5sZW5ndGg9MDtcbiAgICAgICAgICAgIC8vIHRoaXMuZmlsdGVyQnlMb2NhdGlvbigpO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgc2VhcmNoTG9hZGVkKGV2ZW50KSB7XG4gICAgICAgIHRoaXMuc2VhcmNoUGhyYXNlID0gXCJcIjtcbiAgICAgICAgZXZlbnQub2JqZWN0LmFuZHJvaWQuc2V0Rm9jdXNhYmxlSW5Ub3VjaE1vZGUoZmFsc2UpO1xuICAgIH1cblxuICAgIHB1YmxpYyBvblN1Ym1pdChhcmdzKSB7XG4gICAgICAgIGxldCBzZWFyY2hiYXIgPSA8U2VhcmNoQmFyPmFyZ3Mub2JqZWN0O1xuICAgICAgICBzZWFyY2hiYXIuZGlzbWlzc1NvZnRJbnB1dCgpO1xuICAgIH1cblxuXG4gICAgcHVibGljIG9uQ2xlYXIoYXJncykge1xuICAgICAgICBsZXQgc2VhcmNoYmFyID0gPFNlYXJjaEJhcj5hcmdzLm9iamVjdDtcbiAgICAgICAgc2VhcmNoYmFyLmRpc21pc3NTb2Z0SW5wdXQoKTtcbiAgICB9XG5cblxuICAgIG9uUmVnaXN0ZXIoKXtcblxuICAgIHRoaXMucm91dGVyZXh0ZW5zaW9ucy5uYXZpZ2F0ZShbJ3JlZ2lzdGVyJ10pO1xuXG4gICAgfVxuXG4gICAgb25TaWduaW4oKXtcblxuICAgICAgICB0aGlzLnJvdXRlcmV4dGVuc2lvbnMubmF2aWdhdGUoWydzaWduaW4nXSk7XG5cbiAgICB9XG5cbiAgICBvblNpZ25vdXQoKXtcblxuICAgICAgICB0aGlzLmF1dGguc2lnbm91dCgpO1xuICAgIH1cblxuXG4vL0ZvciB5b3VyIHBpY2tzLi4uXG4gICAgICAgIHRvcFRocmVlQ2FmZXMoKXtcblxuICAgICAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UuZnJlcXVlbnRDYWZlKFwiQ0JOVWx1QTZGb2dWSWtPU2xENFdLT0Z2TWpmMVwiKTtcblxuICAgICAgICB9XG5cblxuICAgIG9uVGFwQ3VycmVudE9yZGVyKCl7XG4gICAgICAgIHRoaXMub3JkZXJDb21wbGV4TG9jYWxGaWx0ZXIgPSB0aGlzLm9yZGVyQ29tcGxleExvY2FsLmZpbHRlcihmdW5jdGlvbiAoeCkge1xuICAgICAgICAgICAgcmV0dXJuIHguc3RhdHVzICE9IFwiY29sbGVjdGVkXCJcblxuICAgICAgICB9KVxuICAgIH1cblxuXG4gICAgb25UYXBQYXN0T3JkZXJzKCl7XG4gICAgICAgIHRoaXMub3JkZXJDb21wbGV4TG9jYWxGaWx0ZXIgPSB0aGlzLm9yZGVyQ29tcGxleExvY2FsLmZpbHRlcihmdW5jdGlvbih4KSB7XG4gICAgICAgICAgICByZXR1cm4geC5zdGF0dXMgPT09IFwiY29sbGVjdGVkXCJcbiAgICAgICAgfSlcbiAgICB9XG5cbiAgICB0b3RhbFByaWNlKG9yZGVyOk9yZGVyW10pe1xuICAgICAgICB2YXIgdG90YWw9XCIwXCI7XG4gICAgICAgIG9yZGVyLmZvckVhY2goKHgpPT57XG4gICAgICAgICAgICAvL2ZvciB0b3RhbFxuICAgICAgICAgICAgdG90YWw9KE1hdGgucm91bmQoKHBhcnNlRmxvYXQodG90YWwpKyBwYXJzZUZsb2F0KHgucHJpY2UpKSoxMDApLzEwMCkudG9TdHJpbmcoKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHJldHVybiB0b3RhbDtcbiAgICB9XG5cbiAgICBmaWx0ZXJCeUxvY2F0aW9uKCl7XG4gICAgICAgIGNvbnN0IGRhdGU6IERhdGUgPSBuZXcgRGF0ZSgpO1xuICAgICAgICB0aGlzLml0ZW1zLmZvckVhY2goKHgpPT57XG5cbiAgICAgICAgdGhpcy5teUl0ZW1zLmxlbmd0aD0wO1xuICAgICAgICBsZXQgdGhhdCA9IHRoaXM7XG5cbiAgICAgICAgZ2V0Q3VycmVudExvY2F0aW9uKHtkZXNpcmVkQWNjdXJhY3k6IDEsIHVwZGF0ZURpc3RhbmNlOiAxMCwgbWF4aW11bUFnZTogMjAwMDAsIHRpbWVvdXQ6IDUwMDB9KS5cbiAgICAgICAgdGhlbihmdW5jdGlvbihsb2MpIHtcbiAgICAgICAgICAgIGlmIChsb2MpIHtcbiAgICAgICAgICAgICAgICB2YXIgYSA9IGRpc3RhbmNlKGxvYyx7XCJsYXRpdHVkZVwiOngubGF0LFwibG9uZ2l0dWRlXCI6eC5sbmcsIFwiZGlyZWN0aW9uXCI6MCwgXCJob3Jpem9udGFsQWNjdXJhY3lcIjoxNCxcbiAgICAgICAgICAgICAgICAgICAgXCJ2ZXJ0aWNhbEFjY3VyYWN5XCI6MTQsXCJzcGVlZFwiOjAsXCJhbHRpdHVkZVwiOjg5LFwidGltZXN0YW1wXCI6ZGF0ZX0pO1xuICAgICAgICAgICAgICAgIGlmKGE8MjUwMDApe1xuICAgICAgICAgICAgICAgICAgICB0aGF0Lm15SXRlbXMucHVzaCh4KTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZXtcbiAgICAgICAgICAgICAgICAgICAgLy9yZW1vdmUgdGhpcyB3aGVuIHdlIG5lZWQgZmlsdGVyaW5nIGJ5IGxvY2F0aW9uXG4gICAgICAgICAgICAgICAgICAgIC8vIHRoYXQubXlJdGVtcy5wdXNoKHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgfSwgZnVuY3Rpb24oZSl7XG4gICAgICAgICAgICAvL3B1c2ggYW55d2F5XG4gICAgICAgICAgICB0aGF0Lm15SXRlbXMucHVzaCh4KTtcbiAgICAgICAgfSk7XG5cbiAgICAgICAgfSlcbiAgICB9XG5cbn1cbiJdfQ==