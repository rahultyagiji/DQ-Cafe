"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var item_service_1 = require("../services/item.service");
var router_1 = require("@angular/router");
// import { MapboxViewApi, Viewport as MapboxViewport } from "nativescript-mapbox";
var nativescript_angular_1 = require("nativescript-angular");
var observable_array_1 = require("data/observable-array");
var auth_service_1 = require("../services/auth.service");
var order_service_1 = require("../services/order.service");
var firebase = require("nativescript-plugin-firebase");
//trying location
var nativescript_geolocation_1 = require("nativescript-geolocation");
var color_1 = require("tns-core-modules/color");
// var Vibrate = require("nativescript-vibrate").Vibrate;
// let vibrator = new Vibrate();
var ItemsComponent = /** @class */ (function () {
    function ItemsComponent(itemService, router, routerextensions, auth, orderservice) {
        this.itemService = itemService;
        this.router = router;
        this.routerextensions = routerextensions;
        this.auth = auth;
        this.orderservice = orderservice;
        this.items = [];
        this.myItems = [];
        this.orderList = [];
        this._orderList = new observable_array_1.ObservableArray([]);
        this._items = new observable_array_1.ObservableArray([]);
        this.orderComplexLocal = [];
        this.orderComplexLocalFilter = [];
        this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
        this._order = new observable_array_1.ObservableArray([]);
        this.frequentCafes = [];
        this.startLocation = new nativescript_geolocation_1.Location();
        this.username = "";
        this.tabSelectedIndex = 0;
    }
    ItemsComponent.prototype.ngOnInit = function () {
        var _this = this;
        if (this.items != []) {
            this.itemService.load()
                .subscribe(function (items) {
                _this._items = new observable_array_1.ObservableArray(items);
                _this.items = [];
                _this._items.forEach(function (x) {
                    _this.items.push(x);
                });
                _this.myItems.length = 0;
                _this.filterByLocation();
            });
        }
        else {
            console.log("not loading again");
        }
        //order load for your picks
        firebase.getCurrentUser()
            .then(function (token) {
            console.log(token);
            _this.orderservice.loadOrder(token.uid)
                .subscribe(function (orderlist) {
                _this.orderComplexLocal = [];
                _this._orderList = new observable_array_1.ObservableArray(orderlist);
                _this.orderList = [];
                _this._orderList.forEach(function (x) {
                    _this.orderList.push(x);
                });
                _this.orderList.forEach(function (x) {
                    //get Cafe details
                    _this.orderservice.getOrderDetails(x.cafe, x.orderNo)
                        .then(function (result) {
                        _this.orderDisplay.cafeOwner = _this.itemService.getCafeInfo(x.cafe).name;
                        _this.orderDisplay.imgSrc = _this.itemService.getCafeInfo(x.cafe).imgSrc;
                        _this.orderDisplay.key = result.value.key;
                        _this.orderDisplay.uid = result.value.uid;
                        _this.orderDisplay.status = result.value.status;
                        _this.orderDisplay.orderNo2 = result.value.orderNo2;
                        _this.orderDisplay.order = result.value.order;
                        _this.orderDisplay.total = _this.totalPrice(_this.orderDisplay.order);
                        _this.orderComplexLocal.push(_this.orderDisplay);
                        //this.orderComplexLocalFilter.push(this.orderDisplay);
                        _this.onTapCurrentOrder();
                        _this.orderDisplay = { "key": "", "uid": "", "status": "", "order": null,
                            "cafeOwner": "", "location": "", "orderNo2": "", "imgSrc": "", "total": "" };
                    });
                });
            });
            _this.ontapListofFrequent(token.uid);
        });
    };
    //Frequently visited - to be completed ....
    ItemsComponent.prototype.ontapListofFrequent = function (token) {
        var _this = this;
        var counts;
        this.orderservice.frequentCafe(token)
            .then(function (res) {
            Object.keys(res.value).forEach(function (x) {
                _this.frequentCafes.push(res.value[x].cafe);
            });
        })
            .catch();
    };
    //Navitage to next screen
    ItemsComponent.prototype.jumptoMenu = function (cafeId, args) {
        var page = args.object;
        var view = page.getViewById("cafename");
        view.backgroundColor = new color_1.Color("#f0f0f0");
        view.animate({ backgroundColor: new color_1.Color("white"), duration: 200 });
        this.routerextensions.navigate(["/cafe", cafeId]);
    };
    //
    // //TabView controls
    ItemsComponent.prototype.changeTab = function () {
        if (this.tabSelectedIndex === 0) {
            this.tabSelectedIndex = 1;
        }
        else if (this.tabSelectedIndex === 1) {
            this.tabSelectedIndex = 2;
        }
        else if (this.tabSelectedIndex === 2) {
            this.tabSelectedIndex = 0;
        }
    };
    // search bar
    ItemsComponent.prototype.onTextChanged = function (args) {
        var searchBar = args.object;
        if (searchBar.text != "") {
            var searchValue_1 = searchBar.text.toLowerCase();
            if (searchBar.text != "") {
                this.myItems = this.items.filter(function (item) {
                    return (item.name + " " + item.name).toLowerCase().indexOf(searchValue_1.toLowerCase()) > -1;
                });
            }
            else {
                setTimeout(function () {
                    searchBar.dismissSoftInput();
                }, 300);
            }
        }
        else {
            // this.myItems.length=0;
            // this.filterByLocation();
        }
    };
    ItemsComponent.prototype.searchLoaded = function (event) {
        this.searchPhrase = "";
        event.object.android.setFocusableInTouchMode(false);
    };
    ItemsComponent.prototype.onSubmit = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onClear = function (args) {
        var searchbar = args.object;
        searchbar.dismissSoftInput();
    };
    ItemsComponent.prototype.onRegister = function () {
        this.routerextensions.navigate(['register']);
    };
    ItemsComponent.prototype.onSignin = function () {
        this.routerextensions.navigate(['signin']);
    };
    ItemsComponent.prototype.onSignout = function () {
        this.auth.signout();
    };
    //For your picks...
    ItemsComponent.prototype.topThreeCafes = function () {
        this.orderservice.frequentCafe("CBNUluA6FogVIkOSlD4WKOFvMjf1");
    };
    ItemsComponent.prototype.onTapCurrentOrder = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status != "collected";
        });
    };
    ItemsComponent.prototype.onTapPastOrders = function () {
        this.orderComplexLocalFilter = this.orderComplexLocal.filter(function (x) {
            return x.status === "collected";
        });
    };
    ItemsComponent.prototype.totalPrice = function (order) {
        var total = "0";
        order.forEach(function (x) {
            //for total
            total = (Math.round((parseFloat(total) + parseFloat(x.price)) * 100) / 100).toString();
        });
        return total;
    };
    ItemsComponent.prototype.filterByLocation = function () {
        var _this = this;
        var date = new Date();
        this.items.forEach(function (x) {
            _this.myItems.length = 0;
            var that = _this;
            nativescript_geolocation_1.getCurrentLocation({ desiredAccuracy: 1, updateDistance: 10, maximumAge: 20000, timeout: 5000 }).
                then(function (loc) {
                if (loc) {
                    var a = nativescript_geolocation_1.distance(loc, { "latitude": x.lat, "longitude": x.lng, "direction": 0, "horizontalAccuracy": 14,
                        "verticalAccuracy": 14, "speed": 0, "altitude": 89, "timestamp": date });
                    if (a < 25000) {
                        that.myItems.push(x);
                    }
                    else {
                        //remove this when we need filtering by location
                        // that.myItems.push(x);
                    }
                }
            }, function (e) {
                //push anyway
                that.myItems.push(x);
            });
        });
    };
    ItemsComponent = __decorate([
        core_1.Component({
            selector: "ns-items",
            moduleId: module.id,
            templateUrl: "./items.component.html",
            styleUrls: ["./items.component.css"]
        }),
        __metadata("design:paramtypes", [item_service_1.ItemService,
            router_1.Router,
            nativescript_angular_1.RouterExtensions,
            auth_service_1.AuthService,
            order_service_1.OrderService])
    ], ItemsComponent);
    return ItemsComponent;
}());
exports.ItemsComponent = ItemsComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbXMuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaXRlbXMuY29tcG9uZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsc0NBQWdEO0FBRWhELHlEQUF1RDtBQUN2RCwwQ0FBd0M7QUFDeEMsbUZBQW1GO0FBQ25GLDZEQUFzRDtBQUN0RCwwREFBc0Q7QUFLdEQseURBQXFEO0FBRXJELDJEQUF1RDtBQUV2RCx1REFBMEQ7QUFFMUQsaUJBQWlCO0FBQ2pCLHFFQUE4STtBQUc5SSxnREFBNkM7QUFDN0MseURBQXlEO0FBQ3pELGdDQUFnQztBQVVoQztJQXNCSSx3QkFBb0IsV0FBd0IsRUFDeEIsTUFBYSxFQUNiLGdCQUFpQyxFQUNqQyxJQUFnQixFQUNoQixZQUF5QjtRQUp6QixnQkFBVyxHQUFYLFdBQVcsQ0FBYTtRQUN4QixXQUFNLEdBQU4sTUFBTSxDQUFPO1FBQ2IscUJBQWdCLEdBQWhCLGdCQUFnQixDQUFpQjtRQUNqQyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBeEI3QyxVQUFLLEdBQVMsRUFBRSxDQUFDO1FBQ2pCLFlBQU8sR0FBUSxFQUFFLENBQUM7UUFDbEIsY0FBUyxHQUFvRCxFQUFFLENBQUM7UUFDaEUsZUFBVSxHQUFxRSxJQUFJLGtDQUFlLENBQW1ELEVBQUUsQ0FBQyxDQUFDO1FBQ3pKLFdBQU0sR0FBeUIsSUFBSSxrQ0FBZSxDQUFPLEVBQUUsQ0FBQyxDQUFDO1FBQzdELHNCQUFpQixHQUFnQixFQUFFLENBQUM7UUFDcEMsNEJBQXVCLEdBQWdCLEVBQUUsQ0FBQztRQUMxQyxpQkFBWSxHQUFjLEVBQUMsS0FBSyxFQUFDLEVBQUUsRUFBQyxLQUFLLEVBQUMsRUFBRSxFQUFDLFFBQVEsRUFBQyxFQUFFLEVBQUMsT0FBTyxFQUFFLElBQUk7WUFDbEUsV0FBVyxFQUFDLEVBQUUsRUFBQyxVQUFVLEVBQUMsRUFBRSxFQUFDLFVBQVUsRUFBQyxFQUFFLEVB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LENBQUMsQ0FBQyxHQUFDLEtBQUssQ0FBQyxDQUFBLENBQUM7d0JBQ1IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7b0JBQ3pCLENBQUM7b0JBQ0QsSUFBSSxDQUFBLENBQUM7d0JBQ0QsZ0RBQWdEO3dCQUNoRCx3QkFBd0I7b0JBQzVCLENBQUM7Z0JBQ0wsQ0FBQztZQUNMLENBQUMsRUFBRSxVQUFTLENBQUM7Z0JBQ1QsYUFBYTtnQkFDYixJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN6QixDQUFDLENBQUMsQ0FBQztRQUVILENBQUMsQ0FBQyxDQUFBO0lBQ04sQ0FBQztJQWhQUSxjQUFjO1FBUDFCLGdCQUFTLENBQUM7WUFDUCxRQUFRLEVBQUUsVUFBVTtZQUNwQixRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7WUFDbkIsV0FBVyxFQUFFLHdCQUF3QjtZQUNyQyxTQUFTLEVBQUMsQ0FBQyx1QkFBdUIsQ0FBQztTQUN0QyxDQUFDO3lDQXdCbUMsMEJBQVc7WUFDakIsZUFBTTtZQUNJLHVDQUFnQjtZQUM1QiwwQkFBVztZQUNILDRCQUFZO09BMUJwQyxjQUFjLENBa1AxQjtJQUFELHFCQUFDO0NBQUEsQUFsUEQsSUFrUEM7QUFsUFksd0NBQWMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge0NvbXBvbmVudCwgT25Jbml0fSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgSXRlbSB9IGZyb20gXCIuLi9kYXRhdHlwZXMvaXRlbVwiO1xuaW1wb3J0IHsgSXRlbVNlcnZpY2UgfSBmcm9tIFwiLi4vc2VydmljZXMvaXRlbS5zZXJ2aWNlXCI7XG5pbXBvcnQgeyBSb3V0ZXJ9IGZyb20gXCJAYW5ndWxhci9yb3V0ZXJcIjtcbi8vIGltcG9ydCB7IE1hcGJveFZpZXdBcGksIFZpZXdwb3J0IGFzIE1hcGJveFZpZXdwb3J0IH0gZnJvbSBcIm5hdGl2ZXNjcmlwdC1tYXBib3hcIjtcbmltcG9ydCB7Um91dGVyRXh0ZW5zaW9uc30gZnJvbSBcIm5hdGl2ZXNjcmlwdC1hbmd1bGFyXCI7XG5pbXBvcnQge09ic2VydmFibGVBcnJheX0gZnJvbSBcImRhdGEvb2JzZXJ2YWJsZS1hcnJheVwiO1xuaW1wb3J0IHsgU2VhcmNoQmFyIH0gZnJvbSBcInVpL3NlYXJjaC1iYXJcIjtcblxuXG5cbmltcG9ydCB7QXV0aFNlcnZpY2V9IGZyb20gXCIuLi9zZXJ2aWNlcy9hdXRoLnNlcnZpY2VcIjtcbmltcG9ydCB7T3JkZXJ9IGZyb20gXCIuLi9kYXRhdHlwZXMvb3JkZXJcIjtcbmltcG9ydCB7T3JkZXJTZXJ2aWNlfSBmcm9tIFwiLi4vc2VydmljZXMvb3JkZXIuc2VydmljZVwiO1xuaW1wb3J0IHtPcmRlckRpc3BsYXl9IGZyb20gXCIuLi9kYXRhdHlwZXMvb3JkZXIuZGlzcGxheVwiO1xuaW1wb3J0IGZpcmViYXNlID0gcmVxdWlyZShcIm5hdGl2ZXNjcmlwdC1wbHVnaW4tZmlyZWJhc2VcIik7XG5cbi8vdHJ5aW5nIGxvY2F0aW9uXG5pbXBvcnQge0xvY2F0aW9uLCBpc0VuYWJsZWQsIGVuYWJsZUxvY2F0aW9uUmVxdWVzdCwgZ2V0Q3VycmVudExvY2F0aW9uLCB3YXRjaExvY2F0aW9uLCBkaXN0YW5jZSwgY2xlYXJXYXRjaCB9IGZyb20gXCJuYXRpdmVzY3JpcHQtZ2VvbG9jYXRpb25cIjtcbmltcG9ydCB7QWNjdXJhY3l9IGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL3VpL2VudW1zL2VudW1zXCI7XG5pbXBvcnQge1N0YWNrTGF5b3V0fSBmcm9tIFwidWkvbGF5b3V0cy9zdGFjay1sYXlvdXRcIjtcbmltcG9ydCB7Q29sb3J9IGZyb20gXCJ0bnMtY29yZS1tb2R1bGVzL2NvbG9yXCI7XG4vLyB2YXIgVmlicmF0ZSA9IHJlcXVpcmUoXCJuYXRpdmVzY3JpcHQtdmlicmF0ZVwiKS5WaWJyYXRlO1xuLy8gbGV0IHZpYnJhdG9yID0gbmV3IFZpYnJhdGUoKTtcblxuXG5AQ29tcG9uZW50KHtcbiAgICBzZWxlY3RvcjogXCJucy1pdGVtc1wiLFxuICAgIG1vZHVsZUlkOiBtb2R1bGUuaWQsXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9pdGVtcy5jb21wb25lbnQuaHRtbFwiLFxuICAgIHN0eWxlVXJsczpbXCIuL2l0ZW1zLmNvbXBvbmVudC5jc3NcIl1cbn0pXG5cbmV4cG9ydCBjbGFzcyBJdGVtc0NvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdHtcbiAgICBidXNpbmVzc05hbWU6IFN0cmluZ1tdO1xuICAgIGl0ZW1zOiBJdGVtW109W107XG4gICAgbXlJdGVtczpJdGVtW109W107XG4gICAgb3JkZXJMaXN0OntcIm9yZGVyTm9cIjpzdHJpbmcsXCJjYWZlXCI6c3RyaW5nLFwic3RhdHVzXCI6c3RyaW5nfVtdPVtdO1xuICAgIF9vcmRlckxpc3Q6T2JzZXJ2YWJsZUFycmF5PHtcIm9yZGVyTm9cIjpzdHJpbmcsXCJjYWZlXCI6c3RyaW5nLFwic3RhdHVzXCI6c3RyaW5nfT4gPSBuZXcgT2JzZXJ2YWJsZUFycmF5PHtcIm9yZGVyTm9cIjpzdHJpbmcsXCJjYWZlXCI6c3RyaW5nLFwic3RhdHVzXCI6c3RyaW5nfT4oW10pO1xuICAgIF9pdGVtczpPYnNlcnZhYmxlQXJyYXk8SXRlbT4gPSBuZXcgT2JzZXJ2YWJsZUFycmF5PEl0ZW0+KFtdKTtcbiAgICBvcmRlckNvbXBsZXhMb2NhbDpPcmRlckRpc3BsYXlbXT1bXTtcbiAgICBvcmRlckNvbXBsZXhMb2NhbEZpbHRlcjpPcmRlckRpc3BsYXlbXT1bXTtcbiAgICBvcmRlckRpc3BsYXk6T3JkZXJEaXNwbGF5PXtcImtleVwiOlwiXCIsXCJ1aWRcIjpcIlwiLFwic3RhdHVzXCI6XCJcIixcIm9yZGVyXCI6IG51bGwsXG4gICAgICAgIFwiY2FmZU93bmVyXCI6XCJcIixcImxvY2F0aW9uXCI6XCJcIixcIm9yZGVyTm8yXCI6XCJcIixcImltZ1NyY1wiOlwiXCIsXCJ0b3RhbFwiOlwiXCJ9XG4gICAgX29yZGVyOk9ic2VydmFibGVBcnJheTxPcmRlckRpc3BsYXk+ID0gbmV3IE9ic2VydmFibGVBcnJheTxPcmRlckRpc3BsYXk+KFtdKTtcbiAgICBmcmVxdWVudENhZmVzOnN0cmluZ1tdPVtdO1xuXG5cbiAgICBzdGFydExvY2F0aW9uOkxvY2F0aW9uPW5ldyBMb2NhdGlvbigpO1xuXG4gICAgcHVibGljIHRhYlNlbGVjdGVkSW5kZXg6IG51bWJlcjtcbiAgICBwdWJsaWMgc2VhcmNoUGhyYXNlOiBzdHJpbmc7XG4gICAgdXNlcm5hbWU6c3RyaW5nPVwiXCI7XG4gICAgcHJpdmF0ZSBfY3VycmVudE5vdGlmaWNhdGlvbjogc3RyaW5nO1xuXG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBpdGVtU2VydmljZTogSXRlbVNlcnZpY2UsXG4gICAgICAgICAgICAgICAgcHJpdmF0ZSByb3V0ZXI6Um91dGVyLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgcm91dGVyZXh0ZW5zaW9uczpSb3V0ZXJFeHRlbnNpb25zLFxuICAgICAgICAgICAgICAgIHByaXZhdGUgYXV0aDpBdXRoU2VydmljZSxcbiAgICAgICAgICAgICAgICBwcml2YXRlIG9yZGVyc2VydmljZTpPcmRlclNlcnZpY2UpIHtcbiAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMDtcbiAgICB9XG5cbiAgICBuZ09uSW5pdCgpOiB2b2lkIHtcblxuICAgICAgICBpZih0aGlzLml0ZW1zIT1bXSl7XG4gICAgICAgIHRoaXMuaXRlbVNlcnZpY2UubG9hZCgpXG4gICAgICAgICAgICAuc3Vic2NyaWJlKChpdGVtczogQXJyYXk8SXRlbT4pID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLl9pdGVtcyA9IG5ldyBPYnNlcnZhYmxlQXJyYXkoaXRlbXMpO1xuICAgICAgICAgICAgICAgIHRoaXMuaXRlbXM9W107XG4gICAgICAgICAgICAgICAgdGhpcy5faXRlbXMuZm9yRWFjaCgoeCk9PntcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pdGVtcy5wdXNoKHgpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHRoaXMubXlJdGVtcy5sZW5ndGg9MDtcbiAgICAgICAgICAgICAgICB0aGlzLmZpbHRlckJ5TG9jYXRpb24oKTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2V7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyhcIm5vdCBsb2FkaW5nIGFnYWluXCIpXG4gICAgICAgIH1cblxuXG4vL29yZGVyIGxvYWQgZm9yIHlvdXIgcGlja3NcbiAgICAgICAgZmlyZWJhc2UuZ2V0Q3VycmVudFVzZXIoKVxuICAgICAgICAgICAgLnRoZW4oKHRva2VuKT0+IHtcbiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh0b2tlbilcbiAgICAgICAgICAgICAgICB0aGlzLm9yZGVyc2VydmljZS5sb2FkT3JkZXIodG9rZW4udWlkKVxuICAgICAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKChvcmRlcmxpc3Q6IEFycmF5PHtcIm9yZGVyTm9cIjpzdHJpbmcsXCJjYWZlXCI6c3RyaW5nLFwic3RhdHVzXCI6c3RyaW5nfT4pID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJDb21wbGV4TG9jYWw9W107XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9vcmRlckxpc3QgPSBuZXcgT2JzZXJ2YWJsZUFycmF5KG9yZGVybGlzdCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyTGlzdD1bXTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX29yZGVyTGlzdC5mb3JFYWNoKCh4KT0+e1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJMaXN0LnB1c2goeCk7XG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcblxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckxpc3QuZm9yRWFjaCgoeCk9Pntcbi8vZ2V0IENhZmUgZGV0YWlsc1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyc2VydmljZS5nZXRPcmRlckRldGFpbHMoeC5jYWZlLHgub3JkZXJObylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLnRoZW4oKHJlc3VsdCk9PntcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LmNhZmVPd25lcj10aGlzLml0ZW1TZXJ2aWNlLmdldENhZmVJbmZvKHguY2FmZSkubmFtZTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LmltZ1NyYyA9IHRoaXMuaXRlbVNlcnZpY2UuZ2V0Q2FmZUluZm8oeC5jYWZlKS5pbWdTcmM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5rZXkgPSByZXN1bHQudmFsdWUua2V5O1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vcmRlckRpc3BsYXkudWlkID0gcmVzdWx0LnZhbHVlLnVpZDtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LnN0YXR1cyA9IHJlc3VsdC52YWx1ZS5zdGF0dXM7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheS5vcmRlck5vMiA9IHJlc3VsdC52YWx1ZS5vcmRlck5vMjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5Lm9yZGVyPXJlc3VsdC52YWx1ZS5vcmRlcjtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJEaXNwbGF5LnRvdGFsPXRoaXMudG90YWxQcmljZSh0aGlzLm9yZGVyRGlzcGxheS5vcmRlcilcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub3JkZXJDb21wbGV4TG9jYWwucHVzaCh0aGlzLm9yZGVyRGlzcGxheSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAvL3RoaXMub3JkZXJDb21wbGV4TG9jYWxGaWx0ZXIucHVzaCh0aGlzLm9yZGVyRGlzcGxheSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uVGFwQ3VycmVudE9yZGVyKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9yZGVyRGlzcGxheT0ge1wia2V5XCI6XCJcIixcInVpZFwiOlwiXCIsXCJzdGF0dXNcIjpcIlwiLFwib3JkZXJcIjogbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcImNhZmVPd25lclwiOlwiXCIsXCJsb2NhdGlvblwiOlwiXCIsXCJvcmRlck5vMlwiOlwiXCIsXCJpbWdTcmNcIjpcIlwiLFwidG90YWxcIjpcIlwifTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICAgICAgdGhpcy5vbnRhcExpc3RvZkZyZXF1ZW50KHRva2VuLnVpZCk7XG4gICAgICAgICAgICB9KTtcblxuICAgIH1cblxuLy9GcmVxdWVudGx5IHZpc2l0ZWQgLSB0byBiZSBjb21wbGV0ZWQgLi4uLlxub250YXBMaXN0b2ZGcmVxdWVudCh0b2tlbil7XG4gICAgdmFyIGNvdW50czoge31bXTtcbiAgICAgICAgdGhpcy5vcmRlcnNlcnZpY2UuZnJlcXVlbnRDYWZlKHRva2VuKVxuICAgICAgICAudGhlbihcbiAgICAgICAgICAgIChyZXMpID0+IHtcbiAgICAgICAgICAgICAgICBPYmplY3Qua2V5cyhyZXMudmFsdWUpLmZvckVhY2goKHgpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mcmVxdWVudENhZmVzLnB1c2gocmVzLnZhbHVlW3hdLmNhZmUpO1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KVxuICAgICAgICAuY2F0Y2goKTtcbiAgICAgICAgfVxuXG4vL05hdml0YWdlIHRvIG5leHQgc2NyZWVuXG4gICAgICAgICAgICBqdW1wdG9NZW51KGNhZmVJZCxhcmdzKSB7XG4gICAgICAgICAgICAgICAgbGV0IHBhZ2UgPSA8U3RhY2tMYXlvdXQ+YXJncy5vYmplY3Q7XG4gICAgICAgICAgICAgICAgbGV0IHZpZXcgPSA8U3RhY2tMYXlvdXQ+cGFnZS5nZXRWaWV3QnlJZChcImNhZmVuYW1lXCIpO1xuICAgICAgICAgICAgICAgIHZpZXcuYmFja2dyb3VuZENvbG9yID0gbmV3IENvbG9yKFwiI2YwZjBmMFwiKTtcbiAgICAgICAgICAgICAgICB2aWV3LmFuaW1hdGUoeyBiYWNrZ3JvdW5kQ29sb3I6IG5ldyBDb2xvcihcIndoaXRlXCIpLCBkdXJhdGlvbjogMjAwIH0pO1xuXG4gICAgICAgICAgICAgICAgICAgdGhpcy5yb3V0ZXJleHRlbnNpb25zLm5hdmlnYXRlKFtcIi9jYWZlXCIsIGNhZmVJZF0pO1xuICAgICAgICAgICAgfVxuLy9cbi8vIC8vVGFiVmlldyBjb250cm9sc1xuICAgIGNoYW5nZVRhYigpIHtcblxuICAgICAgICBpZiAodGhpcy50YWJTZWxlY3RlZEluZGV4ID09PSAwKSB7XG4gICAgICAgICAgICB0aGlzLnRhYlNlbGVjdGVkSW5kZXggPSAxO1xuICAgICAgICB9IGVsc2UgaWYgKHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9PT0gMSkge1xuICAgICAgICAgICAgdGhpcy50YWJTZWxlY3RlZEluZGV4ID0gMjtcbiAgICAgICAgfSBlbHNlIGlmICh0aGlzLnRhYlNlbGVjdGVkSW5kZXggPT09IDIpIHtcbiAgICAgICAgICAgIHRoaXMudGFiU2VsZWN0ZWRJbmRleCA9IDA7XG4gICAgICAgIH1cblxuXG4gICAgfVxuXG4vLyBzZWFyY2ggYmFyXG5cbiAgICBwdWJsaWMgb25UZXh0Q2hhbmdlZChhcmdzKSB7XG5cbiAgICAgICAgbGV0IHNlYXJjaEJhciA9IDxTZWFyY2hCYXI+YXJncy5vYmplY3Q7XG4gICAgICAgIGlmIChzZWFyY2hCYXIudGV4dCE9XCJcIil7XG4gICAgICAgIGxldCBzZWFyY2hWYWx1ZSA9IHNlYXJjaEJhci50ZXh0LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmIChzZWFyY2hCYXIudGV4dCAhPSBcIlwiKXtcbiAgICAgICAgICAgIHRoaXMubXlJdGVtcyA9IHRoaXMuaXRlbXMuZmlsdGVyKCBpdGVtID0+IHtcbiAgICAgICAgICAgIHJldHVybiBgJHtpdGVtLm5hbWV9ICR7aXRlbS5uYW1lfWAudG9Mb3dlckNhc2UoKS5pbmRleE9mKHNlYXJjaFZhbHVlLnRvTG93ZXJDYXNlKCkpID4gLTE7XG4gICAgICAgIH0pO1xuICAgICAgICB9XG4gICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgc2V0VGltZW91dChmdW5jdGlvbigpIHtcbiAgICAgICAgICAgICAgICBzZWFyY2hCYXIuZGlzbWlzc1NvZnRJbnB1dCgpO1xuICAgICAgICAgICAgfSwgMzAwKTtcbiAgICAgICAgfVxuICAgIH1cbiAgICBlbHNle1xuICAgICAgICAgICAgLy8gdGhpcy5teUl0ZW1zLmxlbmd0aD0wO1xuICAgICAgICAgICAgLy8gdGhpcy5maWx0ZXJCeUxvY2F0aW9uKCk7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBzZWFyY2hMb2FkZWQoZXZlbnQpIHtcbiAgICAgICAgdGhpcy5zZWFyY2hQaHJhc2UgPSBcIlwiO1xuICAgICAgICBldmVudC5vYmplY3QuYW5kcm9pZC5zZXRGb2N1c2FibGVJblRvdWNoTW9kZShmYWxzZSk7XG4gICAgfVxuXG4gICAgcHVibGljIG9uU3VibWl0KGFyZ3MpIHtcbiAgICAgICAgbGV0IHNlYXJjaGJhciA9IDxTZWFyY2hCYXI+YXJncy5vYmplY3Q7XG4gICAgICAgIHNlYXJjaGJhci5kaXNtaXNzU29mdElucHV0KCk7XG4gICAgfVxuXG5cbiAgICBwdWJsaWMgb25DbGVhcihhcmdzKSB7XG4gICAgICAgIGxldCBzZWFyY2hiYXIgPSA8U2VhcmNoQmFyPmFyZ3Mub2JqZWN0O1xuICAgICAgICBzZWFyY2hiYXIuZGlzbWlzc1NvZnRJbnB1dCgpO1xuICAgIH1cblxuXG4gICAgb25SZWdpc3Rlcigpe1xuXG4gICAgdGhpcy5yb3V0ZXJleHRlbnNpb25zLm5hdmlnYXRlKFsncmVnaXN0ZXInXSk7XG5cbiAgICB9XG5cbiAgICBvblNpZ25pbigpe1xuXG4gICAgICAgIHRoaXMucm91dGVyZXh0ZW5zaW9ucy5uYXZpZ2F0ZShbJ3NpZ25pbiddKTtcblxuICAgIH1cblxuICAgIG9uU2lnbm91dCgpe1xuXG4gICAgICAgIHRoaXMuYXV0aC5zaWdub3V0KCk7XG4gICAgfVxuXG5cbi8vRm9yIHlvdXIgcGlja3MuLi5cbiAgICAgICAgdG9wVGhyZWVDYWZlcygpe1xuXG4gICAgICAgICAgICB0aGlzLm9yZGVyc2VydmljZS5mcmVxdWVudENhZmUoXCJDQk5VbHVBNkZvZ1ZJa09TbEQ0V0tPRnZNamYxXCIpO1xuXG4gICAgICAgIH1cblxuXG4gICAgb25UYXBDdXJyZW50T3JkZXIoKXtcbiAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbEZpbHRlciA9IHRoaXMub3JkZXJDb21wbGV4TG9jYWwuZmlsdGVyKGZ1bmN0aW9uICh4KSB7XG4gICAgICAgICAgICByZXR1cm4geC5zdGF0dXMgIT0gXCJjb2xsZWN0ZWRcIlxuXG4gICAgICAgIH0pXG4gICAgfVxuXG5cbiAgICBvblRhcFBhc3RPcmRlcnMoKXtcbiAgICAgICAgdGhpcy5vcmRlckNvbXBsZXhMb2NhbEZpbHRlciA9IHRoaXMub3JkZXJDb21wbGV4TG9jYWwuZmlsdGVyKGZ1bmN0aW9uKHgpIHtcbiAgICAgICAgICAgIHJldHVybiB4LnN0YXR1cyA9PT0gXCJjb2xsZWN0ZWRcIlxuICAgICAgICB9KVxuICAgIH1cblxuICAgIHRvdGFsUHJpY2Uob3JkZXI6T3JkZXJbXSl7XG4gICAgICAgIHZhciB0b3RhbD1cIjBcIjtcbiAgICAgICAgb3JkZXIuZm9yRWFjaCgoeCk9PntcbiAgICAgICAgICAgIC8vZm9yIHRvdGFsXG4gICAgICAgICAgICB0b3RhbD0oTWF0aC5yb3VuZCgocGFyc2VGbG9hdCh0b3RhbCkrIHBhcnNlRmxvYXQoeC5wcmljZSkpKjEwMCkvMTAwKS50b1N0cmluZygpO1xuICAgICAgICB9KTtcbiAgICAgICAgcmV0dXJuIHRvdGFsO1xuICAgIH1cblxuICAgIGZpbHRlckJ5TG9jYXRpb24oKXtcbiAgICAgICAgY29uc3QgZGF0ZTogRGF0ZSA9IG5ldyBEYXRlKCk7XG4gICAgICAgIHRoaXMuaXRlbXMuZm9yRWFjaCgoeCk9PntcblxuICAgICAgICB0aGlzLm15SXRlbXMubGVuZ3RoPTA7XG4gICAgICAgIGxldCB0aGF0ID0gdGhpcztcblxuICAgICAgICBnZXRDdXJyZW50TG9jYXRpb24oe2Rlc2lyZWRBY2N1cmFjeTogMSwgdXBkYXRlRGlzdGFuY2U6IDEwLCBtYXhpbXVtQWdlOiAyMDAwMCwgdGltZW91dDogNTAwMH0pLlxuICAgICAgICB0aGVuKGZ1bmN0aW9uKGxvYykge1xuICAgICAgICAgICAgaWYgKGxvYykge1xuICAgICAgICAgICAgICAgIHZhciBhID0gZGlzdGFuY2UobG9jLHtcImxhdGl0dWRlXCI6eC5sYXQsXCJsb25naXR1ZGVcIjp4LmxuZywgXCJkaXJlY3Rpb25cIjowLCBcImhvcml6b250YWxBY2N1cmFjeVwiOjE0LFxuICAgICAgICAgICAgICAgICAgICBcInZlcnRpY2FsQWNjdXJhY3lcIjoxNCxcInNwZWVkXCI6MCxcImFsdGl0dWRlXCI6ODksXCJ0aW1lc3RhbXBcIjpkYXRlfSk7XG4gICAgICAgICAgICAgICAgaWYoYTwyNTAwMCl7XG4gICAgICAgICAgICAgICAgICAgIHRoYXQubXlJdGVtcy5wdXNoKHgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNle1xuICAgICAgICAgICAgICAgICAgICAvL3JlbW92ZSB0aGlzIHdoZW4gd2UgbmVlZCBmaWx0ZXJpbmcgYnkgbG9jYXRpb25cbiAgICAgICAgICAgICAgICAgICAgLy8gdGhhdC5teUl0ZW1zLnB1c2goeCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9LCBmdW5jdGlvbihlKXtcbiAgICAgICAgICAgIC8vcHVzaCBhbnl3YXlcbiAgICAgICAgICAgIHRoYXQubXlJdGVtcy5wdXNoKHgpO1xuICAgICAgICB9KTtcblxuICAgICAgICB9KVxuICAgIH1cblxufVxuIl19